---
layout: single
title:  "Railsを使った開発速度＆品質向上のためのスクラム開発の研究および自社サービスの開発"
header:
  teaser : /assets/images/ruby.png
  show_overlay_excerpt: false
  overlay_color: "#333"
---

## 概要

[１つ前の記事](/portfolio/2018-04-15-what-is-agile)では「アジャイル風」を改善し、炎上プロジェクトを優良プロジェクトに改革しました。

しかし、どんなに頑張ってもミニウォーターフォール以上にはならず、速度も品質もこれが限界という状況でした。個人的にはもっとよいやり方ができると信じていましたので、プロジェクトの管理手法だけでなく、プログラミング作法まで見直し、これまでの限界を突破する開発方法の研究を行いました。なお、現時点では法人化もしていなければ、サンプルアプリでしかありませんが、将来的に私個人の自社サービスとなるといいなと思って、自社サービスと書いております。

### 実績

* サイトの作成
  * [EscapeSurvive](https://escape-survive.herokuapp.com/)
* Railsドキュメントへのプルリクエスト
  * [#32572](https://github.com/rails/rails/pull/32572)
* 以下の知見


### 立場

PO,PM,PG

## プロジェクト運営

### コンセプトメイキング

要件定義や仕様設計など、上流工程はその後のすべてに影響する重要な仕事ですが、ここが机上の空論になってしまったり時間をかけすぎてしまってもよく勿体無いです。どうにかして上流工程を正しくそして適量に行えいないものでしょうか？

答えは、 **走りながら考える** です。もちろん走り出す前に「なぜ走るのか？」「どこまでどのように走るのか？」を考えますが、「あのコーナーをこのスピードで走る」なんてことまでは考えません。走っている最中に、走る理由や目的地が変わるかもしれません。走り出す前に将来の気変わりに備えておくのではなく、気持ちが変わった時にすぐにコンセプトメイキングをし直すことです。

* [最初のコンセプトメイキング]({{ site.baseurl }}{% post_url 2018-03-19-EscapeSurfing %})
* [2回目のコンセプトメイキング]({{ site.baseurl }}{% post_url 2018-04-09-EscapeSurfing %})

### 仕様設計

実は「仕様設計／ソフトウェア設計」をどう捉えるかの理解が「走りながら考える」を支えられるかどうかの最も大きなポイントです。アイディアの詳細については、以下の論文、論文を引用した倉貫さんのブログ、Matzの名言を参照してください。

* [ソフトウェア設計とは何か？](http://web.archive.org/web/20080825060915/http://www.biwa.ne.jp/~mmura/SoftwareDevelopment/WhatIsSoftwareDesignJ.html)
* [ソフトウェア設計とは何か 〜 設計にはプログラミング経験が必要か否か](https://kuranuki.sonicgarden.jp/2013/01/post-109.html)
* <blockquote class="twitter-tweet" data-lang="en"><a href="https://twitter.com/matz_meigen_bot/status/984908876070793216"></a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

ここで重要なことは「仕様設計とソフトウェア設計は協調作業である」ということです。これまでのウォーターフォールの前提である仕様設計(外部設計・基本設計)をして逆戻りしない前提で「ソフトウェア設計(内部設計・詳細設計)」をするのではありません。製造というコーディング工程は存在しません。製造はビルドであり、ビルドはコンピュータが数秒以内に終わらせるのでコストがほぼ0と無視できるものなので工程として捉えません。

後戻りできない仕様設計ではなく、協調作業の仕様設計になって変わるのは、「設計書を書く」という行為が「コンセプトを満たす仕様はどうあるべきか？」を考える行為に変わります。もちろん設計書を書きながら考えることもできますが、もっと考えること、対話することに集中し、設計書そのもののアウトプットを重要視しません。その結果、各画面でなにをしたいか？ルーティングはどうするか？データベースはどうするか？程度のスケッチを描き、すぐにプログラミングで実際のルーティングをスケッチし、良さそうであればモデルおよびデータベース設計を行い、実現できそうかを１、２時間、長くても４時間程度で検証します。

このように仕様を考える際に「できそうかどうか？」のフィードバックを素早く得て、フィードバックをもとに舵を切ることができます。また、設計書を作ることが目的ではないため、資料もこの１枚に済んでおり、結果、仕様設計にかかる時間が1/5〜1/10程度に下がったと感じています。ただし、強調しておきますが、これはビジネス側とエンジニアの協調作業ですので、一緒に対話して仕様設計をした結果資料ができあがると捉えるのであって、エンジニアが作った資料をビジネス側がレビュするではないことに注意してください。

{% include figure image_path="/assets/images/EscapeSurvive_outline_design.png" alt="仕様設計で作った資料" caption="仕様設計で作った資料" %}


### ソフトウェア設計

ソフトウェア設計は、仕様設計で決めたスケッチを基に、肉付けをしていく作業です。仕様設計もスケッチに過ぎないので、必要に応じて立ち戻り仕様を修正し、ソフトウェアを作り込んでいきます。これまでの方法論と違うところは「仕様が絶対」ではなく「仕様を通じて提供したい価値」を対話を通じて理解しておき、価値を崩さないかより高めるための提案をガンガンしていこうというものです。

##### ①モデリングとルーティングを行い、RESTを意識した自然な設計を考える
##### ②[モデルが人であるかのように質問を投げかけることでモデルを設計](http://amzn.asia/986h0ud)し、仕様としてモデルテストを書く
##### ③モデルを書き、テストを通過するプログラムを書く
##### ④コントローラと画面を書き、大まかに動きをスケッチする(コントローラにロジックを入れないように注意する)
##### ⑤全体を見直して、仕様設計でやりたかったことができそうか確認し、詳細を作り込む
##### ⑥統合テストを書き、考えそびれた仕様も盛り込み、改めて失敗するコードを修正し、完成度を高めていく

以上の工程を通じて、テストで保護されたプログラムが手に入ります。また、オブジェクト同士の会話を意識することで、メッセージングがオブジェクト指向な設計を作り、変更に強いコードを作ることができます。

### デプロイ

第１スプリントからデプロイします。アジャイルとウォーターフォールの本質的な違いが以下のモナリザの絵で示されているように、アジャイルでは最小の価値から提供を開始して、価値を大きくしていく。（顧客にプレスリリースするタイミングとは別でいいと思いますが）

<blockquote class="twitter-tweet" data-lang="en"><a href="https://twitter.com/naoki_ishigaki/status/982704534240673792"></a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


今回はHeroku、AWS S3, SES を使いました。クラウドサービスを利用することで、１からサーバを立てるより早く構築することができました。
今後は、コンテナを使ったオーケストレーションも考えていきたいと考えています。




### 管理

今回は、かんばん方式を使った５日間×５回スプリントで開発することにしました。
各スプリントでのスピードは次のとおりです。チケットはストーリーポイント法で見積もっており、1,3,5,7,9,13から数字を選ぶようにしています。
ストリートポイント法は、理想時間数見積よりも、時間数を意識せずに相対見積ができるので、#2スプリント以降、直感的に正しい見積ができるようになっていきました。

全体的にガタガタして見えるのは、途中でチケットを足しているせいです。全体を通しての消火は濃い緑色ではなく、点線となります。




###### #１スプリント
![image-left](/assets/images/sprint1.png){: .align-left}

当初、25ポイント見積に対し、50ポイントの消火となりました。デプロイ環境を作り、ログインページ、ツイッター連携ログインおよび、ユーザ登録機能、およびレスポンシブ対応されたログイン後のページ、RSpecによるテストを構築しました。


###### #2スプリント
![image-left](/assets/images/sprint2.png){: .align-left}

当初、25ポイント見積に対し、40ポイントの消火となりました。ユーザのプロフィール編集および、サポーター、サバイバー機能、静的エラーページの追加、Ajaxによる動的な市町村データ取得と表示を行えるようにしました。

###### #3スプリント
![image-left](/assets/images/sprint3.png){: .align-left}

当初、55ポイント見積に対し、70ポイントの消火となりました。ユーザ一覧ページ、ページング、セッション管理、テストの追加、強制ブラウズ攻撃対応、画像のアップロード、画像のサイズ修正、退会処理を行えるようにしました。


###### #4スプリント
![image-left](/assets/images/sprint4.png){: .align-left}

当初、45ポイント見積に対し、46ポイントの消火となりました。ユーザ同士のメッセージ送信、ツイッターアカウント公開機能、相互評価機能、通知メール機能を追加しました。新たにモデルを追加したり機能を追加するのが楽になってきました。

###### #5スプリント
![image-left](/assets/images/sprint5.png){: .align-left}

当初、30ポイント見積に対し、55ポイントの消火となりました。改行やURLが表示されるように修正し、URLの対応については、XSS攻撃のスクリプトを流してXSS攻撃が発現しないことを確認しました。その他、小さな修正および、Flashを全画面で統一的にヘッダやリンクなど複雑な表示に対応できるようにしました。そして最後の２日で日記機能を追加しました。
